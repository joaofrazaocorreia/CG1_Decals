# Delivery Report

##### João Correia, a22202506
#
#
## Project implementation

The goal of this project was to implement a shader in Unity that is capable of rendering Decals on the geometry in the scene, such as walls and floor.

To do this, I created a project in Unity using the Universal Render Pipeline (URP) and built a small scene using a few cubes to act as floor and walls, where I would be testing the projection of the Decals. Following the concepts of Shader Graphs learnt in CG class, I created a Lit Shader Graph, along with a material to use it, and "warmed up" by doing some small exercises such as changing the base color, using normals, etc. Essentially, remembering the basics.

I then began my research to find a way to implement Decals. Most tutorials, forums, and other kinds of videos or websites, were all using Unity's Decal Projector as a way to project their Decals into the scene, but since my goal was to render the Decals myself, I avoided these. I ended up finding Daniel Ilett's implementation tutorial (which is based on [NiloCat's approach](https://github.com/ColinLeung-NiloCat/UnityURPUnlitScreenSpaceDecalShader)), which I decided to follow to get me started.

First, I needed the Screen Position of the object (the center) and the Depth Buffer (Scene Depth) in order to determine the intersection between the object that would render the Decal (I used cubes as the model to render them) and the geometry in the scene. The projection of the Decal is done in the Z axis, so I took the X and Y coordinates from the object's Screen Position and used the Depth Buffer as the Z coordinate to make the object detect surfaces on that direction. I also had to negate the Y coordinate, otherwise the Decal would be inverted and would also not be rendered in the correct place in the scene. 

Next, I needed to convert the coordinates to World Space in order to assign the Decal a constant position in the scene, since I was currently working with View Space and this would cause the Decal's position to change depending on the camera position. I achieved this by using a transformation matrix and multiplying it by the previously calculated coordinates, however this results in a Vector4 due to homogeneous coordinates in matrix calculus. By dividing the obtained coordinates by the homogeneous coordinates, I achieved a permanent position in World Space for the Decal to be rendered in, regardless of where the camera is. 

Then I converted this position into Object Space so the object could render the Decal on itself, but now the cube now had its positions ranging from (-0.5, -0.5, -0.5) to (0.5, 0.5, 0.5). In order to delete any pixels outside of the object's range (to prevent it from rendering anything that isn't inside the cube's volume), I used 'Step' nodes to determine which pixels were within the object's position, by checking which pixels were at (-0.5, -0.5, -0.5) or more, and which were at (0.5, 0.5, 0.5) or less. Then, using an 'All' node between these two, I obtained only the area within the object's position, which I passed onto a 'Branch' node, to make sure that only the pixels marked as "True" (the ones with a value of 1, which are the ones inside the calculated area) will be drawn, and the rest won't, resulting in an Alpha value that only renders the area inside the cube.

Lastly, I needed to adjust the position of the Decal's UV, which could be done by adding 0.5 to the Object Space Position (to make it range between 0 and 1 instead of -0.5 and 0.5). With the image now properly alligned, it was ready to be used as the Base Color for the shader to render, and making use of the Alpha values of this image, multiplied by the area within the cube (calculated in the previous paragraph), I obtained only the area that enveloped the sprite within the cube, which is the Alpha value that the shader would use to render the Decal. For some small adjustments, I enabled Alpha Clipping and set it as an editable variable, to allow me to control the minimum opacity that would be rendered in.

However, this shader was using the Lit Shader Graph, which I assumed would cause the lighting in the scene to affect the Decal upon being rendered. This was not the case, as I quickly noticed that the lighting was affecting the object as if it still were the full cube, causing the shading on the Decal to look different depending on each side of the cube. I tried changing the shader into Unlit, to prevent the scene lighting to affect it, but it now also didn't affect the rendered Decal (it always used the same color, whether it was exposed to light or not).

I decided to duplicate the shader to separate it into one Lit and one Unlit, hoping that I could find a fix for either of them. Initially I assumed the lighting was affecting the cube because of the Alpha Clipping, thinking it didn't draw the cube's pixels but still rendered them invisible. I searched online for a solution or a fix, but I wasn't able to solve the problem. I tried to see what would happen if I inverted the values on the 'Branch' node and, without a sprite attached to the shader, the cube turned into a grey void with seemless edges, which immediately reminded me of a toon shader. I found this to be interesting, so I kept a copy of it and put it into the back of the scene.

After that, as I was moving the Lit Shader around the scene, I came across another bug: when the Camera is inside the cube, the Decal disappears, but everything outside remains the same. This made me realise that the issue wasn't the Alpha Clipping, but it was the object itself. The Decal was being rendered in the right position, but it was being drawn on the cube instead of the other objects' textures. This meant that the lighting couldn't affect the Decal correctly because it would always hit the cube, and it would disappear if the camera got inside the object's volume because Unity makes meshes invisible when the camera clips through them.

My only options were to either draw the Decal onto the texture of the things it hit or to resize the cube and make it too thin for the camera to clip through. The second option worked fine, but it was very impratical for applying the Decal on a corner, since it limited how thin it could be while affecting all the area around the corner. I decided to search how to make the Decal be rendered into the other objects instead of the cube, and I even found and read part of a presentation about how Warhammer 40000 implemented their Screen Space Decals, however I was unable to find a solution anywhere. I assume I would've needed to get the texture from each of the objects detected by the shader, and then I could draw the Decal's texture on top of theirs, which would fix both the bug where the lighting hits the cube instead of the Decal (since now it would be rendering on the object where the Decal is drawn) and would prevent it from disappearing since, even if the camera got inside the object with the shader, the Decal is drawn on another object, so it wouldn't matter whether the cube disappeared or not.

Unfortunately, the only fix I could find for this issue was to use Unity's Decal Projector. I found Navarone's video on the implementation of Decals using the Projector, and I noticed that it used a pre-made Decal Shader using a Decal Shader Graph. This prompted me to attempt to make my own Decal Shader Graph to use in the projector, so I tried to follow the API on the Unity URP Manual and created a Decal Shader that accepts many mask textures, allowing the shader to control the Normal, Metallic, Smoothness and Ambient Occlusion of the surface hit through the use of these masks. I also added an option to control the color and the intensity of an Emission Color, allowing the Decal to emit colored light, and added some values to help control the opacity of the masks, allowing the decal to blend more easily with the surface hit (for example, if the Decal is being projected onto a rugged wall, a lower opacity would make the Decal's normal map combine with the rugged texture instead of just overriding it).

I still tried looking through the shader's code, searching for a way to draw the Decal into whatever surface the cube hit, but I couldn't figure out a way to draw it on other objects' textures. Another thing that bothered me in all 3 of the Decal Shaders is the fact that the Decal kept being drawn multiple times in a scene for each surface that it hit, instead of only drawing itself (or part of itself) on the first surface hit by each pixel. I wanted to find a way to render the Decal in a way similar to a spotlight, where the light hits an object and doesn't hit whatever was behind said object (for example, if you point a light to a pole, the light will keep travelling around the pole, but the area right behind the pole will have a shadow because the light didn't go through). I was also unable to fix for this issue, although this time it was mostly due to lack of time, and could probably have solved it by either not allowing the Decal's texture to be drawn anywhere if it's already been drawn somewhere before, or by using a raycast to determine the first surface hit and draw the Decal only on it.

## References and Sources

#### Tutorials

- [Decals & Stickers in Unity Shader Graph and URP](https://www.youtube.com/watch?v=f7iO9ernEmM&ab_channel=DanielIlett) by [Daniel Ilett](https://www.youtube.com/@danielilett)
- [UNITY 2021.2 | URP 12 | Easy Decals Under 5 MINUTES](https://www.youtube.com/watch?v=P4HwA-O9vB4&ab_channel=Navarone) by [Navarone77](https://www.youtube.com/@navarone77)

#### Technical References

- [Computação Gráfica - Aula 06/12/2023](https://www.youtube.com/watch?v=W_OeOSBnfUs&ab_channel=DiogoAndrade) by [Diogo Andrade](https://www.youtube.com/@diogoandrade9588)
- [Computação Gráfica - Aula 13/12/2023](https://www.youtube.com/watch?v=j3Fnfhb2z0E&ab_channel=DiogoAndrade) by [Diogo Andrade](https://www.youtube.com/@diogoandrade9588)
- [Screen Space Decals in Warhammer 40,000: Space Marine](https://www.slideshare.net/blindrenderer/screen-space-decals-in-warhammer-40000-space-marine-14699854?fbclid=IwAR2X6yYeWmDiz1Ho4labx3zA3GATpC7fi5qNkzjEj-MYTOBpXnkIsnA3T-A) by [Pope Kim](https://www.slideshare.net/blindrenderer?utm_campaign=profiletracking&utm_medium=sssite&utm_source=ssslideview)
- [Decal Shader Graph](https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@14.0/manual/decal-shader.html) API in [Unity](https://unity.com/)

#### Images used

- [Blood splatter png](https://pnghq.com/category/blood-splatter-png/)
- [Graffiti Art Sticker](https://www.pinterest.com/pin/771804454888170627/)
- [Wall crack png](https://static.wixstatic.com/media/1f859f_c5364ee8005b457786f284a067cb42a4~mv2.png/v1/fill/w_700,h_700,al_c,q_90,usm_0.66_1.00_0.01,enc_auto/%E2%80%94Pngtree%E2%80%94black%20broken%20wall%20damage%20brick_5476239.png) (from https://www.run-ne.com/wlm)

